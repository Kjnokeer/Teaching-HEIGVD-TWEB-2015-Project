<!DOCTYPE html>
<html class='no-js' lang='en'>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <title>MaMaThiVa</title>
    <meta content='lab2023' name='author'>
    <meta content='' name='description'>
    <meta content='' name='keywords'>
    <link href="assets/stylesheets/application-a07755f5.css" rel="stylesheet" type="text/css" />
    <link href="assets/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/chart/angular-chart.css">
    <link href="assets/images/logo_t.png" rel="icon" type="image/ico" />
    <link rel="stylesheet" type="text/css" href="css/style.css">
  </head>
  <body class='main page' ng-app="app">
    <!-- Navbar -->
    <div class='navbar navbar-default' id='navbar'>
      <a class='navbar-brand' ui-sref="home">
        <i><img src="assets/images/logo_t.png" width="32px"></i>
        MaMaThiVa - Easy Polls
      </a>
      <ul class='nav navbar-nav pull-right'>
        <li class='dropdown user'>
          <a class='dropdown-toggle' data-toggle='dropdown' href='#'>
            <i class='icon-user'></i>
            <strong><%= email %></strong>
            <img class="img-rounded" src="http://placehold.it/20x20/ccc/777" />
            <b class='caret'></b>
          </a>
          <ul class='dropdown-menu'>
            <li>
              <a ui-sref="gestion">Edit Profile</a>
            </li>
            <li class='divider'></li>
            <li>
              <a href="/logout">Sign out</a>
            </li>
          </ul>
        </li>
      </ul>
    </div>
    <div id='wrapper'>
      <!-- Sidebar -->
      <section id='sidebar'>
        <i class='icon-align-justify icon-large' id='toggle'></i>
        <ul id='dock'>
          <li class='active launcher' ui-sref-active="active" style="margin-top: 35px;">
            <i class='icon-dashboard'></i>
            <a ui-sref="polls">Polls</a>
          </li>
          <li class='launcher' ui-sref-active="active" style="margin-top: 35px;">
            <i class='icon-file-text-alt'></i>
            <a ui-sref="statistics">Statistics</a>
          </li>
          <li class='launcher' ui-sref-active="active" style="margin-top: 35px;">
            <i class='icon-table'></i>
            <a ui-sref="manage">Manage account</a>
          </li>
        </ul>
        <div data-toggle='tooltip' id='beaker' title='Made by lab2023'></div>
      </section>
      <!-- Tools -->
      <section id='tools'>
        <ul class='breadcrumb' id='breadcrumb'>
          <li class='title'>MaMaThiVa</li>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          <li></li>
          <li style="display:inline;" ncy-breadcrumb></li>
        </ul>
        <div id='toolbar'>
          <div class='btn-group'>
            <a class='btn' data-toggle='toolbar-tooltip' href='#' title='Building'>
              <i class='icon-building'></i>
            </a>
            <a class='btn' data-toggle='toolbar-tooltip' href='#' title='Laptop'>
              <i class='icon-laptop'></i>
            </a>
            <a class='btn' data-toggle='toolbar-tooltip' href='#' title='Calendar'>
              <i class='icon-calendar'></i>
              <span class='badge'>3</span>
            </a>
            <a class='btn' data-toggle='toolbar-tooltip' href='#' title='Lemon'>
              <i class='icon-lemon'></i>
            </a>
          </div>
        </div>
      </section>

      <!-- Content -->
    <div id='content'>
      <section ui-view>
        <h1>Welcome on MaMaThiVa<h1>

      </section>
    </div>



    <!-- Footer -->
    <!-- Javascripts -->
    <script src="js/jquery/jquery.min.js"></script>
    <script src="js/angular/angular.min.js"></script>
    <script src="js/chart/chart.js"></script>
    <script src="js/chart/angular-chart.js"></script>
    <script src="js/angular/angular-ui-router.js"></script>
    <script src="components/angular-breadcrumb/dist/angular-breadcrumb.min.js" type="text/javascript"></script>
    <script src="assets/javascripts/jquery-ui.min.js" type="text/javascript"></script>
    <script src="assets/javascripts/modernizr.min.js" type="text/javascript"></script>
    <script src="assets/javascripts/application-9e04b2b6.js" type="text/javascript"></script>
    <!-- Google Analytics -->

    <script>
      angular.module("app", ["chart.js", "ui.router", "ncy-angular-breadcrumb"])
       .factory('socket', function(socketFactory) {
          return socketFactory();
       })
       .controller('PollsCtrl', function($scope, $http, $state) {

          $scope.labels = [];
          $scope.data = [];

          $scope.loadPolls = function() {
            $http.get("/user/polls").then(function(response) {
              $scope.polls = response.data;
            });
          }

          $scope.deletePoll = function (id) {
            $http.delete('/api/polls/' + id)
              .success(function (data) {
                 $scope.error = "error " + data;
              });

            $http.get("/user/polls").then(function(response) {
              $scope.polls = response.data;
            });
          }

          $scope.submitPoll = function() {
            $http.post('/user/polls/', {
              title: $scope.title,
              state: $scope.state
            }).then(function(response) {  
              $state.go('createQuestion', {pollId: response.data._id});
            });
          }

          $scope.finish = function() {
            $state.go('polls');
          }

          $scope.submitQuestion = function(pollId) {

            $http.post('/api/polls/' + pollId + '/questions', {
              title: $scope.title,
              type: 'choice'
            }).then(function(response) {
              var i = 1;
              while(true) {
                if(!$scope['choice' + i])
                  break;

                $http.post('/api/polls//questions/' + response.data._id + '/choices', {
                  key: 'key',
                  text: $scope['choice' + i]
                });

                i++;
              }
              if($scope.finish === true)
                $state.go('polls');
              else
                $state.go($state.current, {pollId: pollId}, {reload: true});
            });
          }

          $scope.showStatistics = function(pollId) {
            $state.go('statisticsPoll', {pollId: pollId, questionId: 0});
          }

          $scope.loadStatistics = function(pollId, questionId) {
            $http.get('/api/polls/' + pollId).then(function(response) {
              $scope.title = response.data.title;
            });
            $http.get('/api/polls/' + pollId + '/questions').then(function(response) {

              $scope.question = response.data[questionId];
              $scope.nbQuestions = response.data.length;

              $http.get('/api/polls/*/questions/' + response.data[questionId]._id + '/choices').then(function(response) {

                  $scope.labels = [];
                  $scope.data = [];

                  var choices = response.data;

                  for(var i in choices) {
                    $scope.labels.push(choices[i].text);
                    
                    $http.get('/api/choices/' + choices[i]._id + '/answers').then(function(response) {
                      $scope.data.push(response.data.length);
                    });

                  }
              });
            });
          }

          $scope.nextQuestion = function(pollId) {
            $scope.questionId++;
            $state.go('statisticsPoll', {pollId: pollId, questionId: $scope.questionId});
          }

          $scope.previousQuestion = function(pollId) {
            $scope.questionId--;
            $state.go('statisticsPoll', {pollId: pollId, questionId: $scope.questionId});
          }

          $scope.checkPreviousQuestion = function() {
            if ($scope.questionId == 0) { 
              return true;
            } else {
              return false;
            }
          };

          $scope.checkNextQuestion = function() {
            if ($scope.questionId == $scope.nbQuestions - 1) { 
              return true;
            } else {
              return false;
            }
          };
       })
	   .controller('ManageCtrl', function($scope, $http, $state) {
          $scope.loadUserInfo = function() {
            $http.get("/user/account").then(function(response) {
              $scope.user = response.data;
            });
          };

          $scope.submitUserInfos = function() {

              $http.put('/user/account/', {
                firstname: $scope.user.firstname,
                lastname: $scope.user.lastname,
                password: $scope.password
              });

              alert('Success');
          };
       })
       .config(function($stateProvider) {
          $stateProvider.state('home', {
             templateUrl: 'partials/home/home.html',
             url: '/home',
             ncyBreadcrumb: {
                label: 'Home'
             }
          });
          $stateProvider.state('polls', {
             templateUrl: 'partials/home/polls.html',
             url: '/polls',
             ncyBreadcrumb: {
                label: 'Polls'
             }
          });
          $stateProvider.state('statistics', {
             templateUrl: 'partials/home/statistics.html',
             url: '/statistics',
             ncyBreadcrumb: {
                label: 'Statistics'
             }
          });
          $stateProvider.state('statisticsPoll', {
             templateUrl: 'partials/home/statistics-poll.html',
             url: '/statisticsPoll?pollId&questionId',
             ncyBreadcrumb: {
                label: 'Statistics of a poll'
             },
             controller: function($scope, $stateParams, $state) {
                $scope.pollId = $stateParams.pollId;
                $scope.questionId = $stateParams.questionId;
             }
          });
          $stateProvider.state('manage', {
             templateUrl: 'partials/home/manage.html',
             url: '/manage',
             ncyBreadcrumb: {
                label: 'Manage your account'
             },
             params: {
                message: 'None'
             }
          });
          $stateProvider.state('createPoll', {
             templateUrl: 'partials/home/create-poll.html',
             url: '/createPoll',
             ncyBreadcrumb: {
                label: 'Create a poll'
             }
          });
          $stateProvider.state('createQuestion', {
             templateUrl: 'partials/home/create-question.html',
             url: '/createQuestion?pollId',
             ncyBreadcrumb: {
                label: 'Create a question'
             },
             controller: function($scope, $stateParams, $state) {
                $scope.pollId = $stateParams.pollId;
             }
          });
       });
    </script>

  </body>
</html>
